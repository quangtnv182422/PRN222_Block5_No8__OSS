@model IEnumerable<OSS_Main.Models.Entity.AspNetUser>

@{
    Layout = "_LayoutAdmin";
    ViewData["Title"] = "AccountList";
}

<main class="bg-light">
    <div class="p-4">
        <!-- Header -->
        <div class="d-flex justify-content-between pt-3 pb-2">
            <h1 class="mb-0">User List</h1>
            <nav class="d-inline-block mt-4 mt-sm-0">
                <ul class="breadcrumb bg-transparent rounded mb-0 p-0">
                    <li class="breadcrumb-item"><a asp-controller="Dashboard" asp-action="">Admin</a></li>
                    <li class="breadcrumb-item active">User List</li>
                </ul>
            </nav>
        </div>

        <!-- Search and Add New User -->
        <div class="d-flex justify-content-end align-items-center mb-3">
            <form method="get" class="d-flex">
                <input type="text" name="searchQuery" class="form-control me-2" style="width:270px" placeholder="Search user..." value="@ViewBag.SearchQuery">
                <button type="submit" class="btn btn-primary text-white">
                    <i class="bi bi-search"></i>
                </button>
            </form>
        </div>

        <!-- Filter dropdown -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <button class="btn btn-primary btn-md text-white fw-bold" data-bs-toggle="modal" data-bs-target="#addUserModal">
                <i class="bi bi-plus"></i> New User
            </button>
            <form method="get" class="d-flex">
                <select name="roleFilter" class="form-select me-2">
                    <option value="">All Roles</option>
                    <option value="Customer" selected="@(ViewBag.RoleFilter == "Customer")">Customer</option>
                    <option value="Admin" selected="@(ViewBag.RoleFilter == "Admin")">Admin</option>
                    <option value="Sales" selected="@(ViewBag.RoleFilter == "Sales")">Sales</option>
                </select>
                <select name="statusFilter" class="form-select me-2">
                    <option value="">All Status</option>
                    <option value="Active" selected="@(ViewBag.StatusFilter == "Active")">Active</option>
                    <option value="Deactivated" selected="@(ViewBag.StatusFilter == "Deactivated")">Deactivated</option>
                </select>
                <button type="submit" class="btn btn-primary"><i class="bi bi-funnel-fill text-white"></i></button>
            </form>
        </div>

        <!-- User Table -->
        <div class="table-responsive shadow rounded text-center">
            <table class="table table-centered bg-white mb-0">
                <thead>
                    <tr>
                        <th class="border-bottom p-3">Username</th>
                        <th class="border-bottom p-3">Email</th>
                        <th class="border-bottom p-3">Phone</th>
                        <th class="border-bottom p-3">Gender</th>
                        <th class="border-bottom p-3">Role</th>
                        <th class="border-bottom p-3">Status</th>
                        <th class="border-bottom p-3">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var user in Model)
                    {
                        <tr>
                            <td class="p-3 align-middle">@user.UserName</td>
                            <td class="p-3 align-middle">@user.Email</td>
                            <td class="p-3 align-middle">@user.PhoneNumber</td>
                            <td class="p-3 align-middle">@(user.Gender ? "Male" : "Female")</td>
                            <td class="p-3 align-middle">
                                @{
                                    var userRoles = ViewBag.UserRoles[user.Id] as List<string> ?? new List<string>();
                                }
                                @(userRoles.Any() ? string.Join(", ", userRoles) : "No Role")
                            </td>

                            <td class="p-3 align-middle">
                                <span class="badge @(user.LockoutEnabled ? "bg-danger" : "bg-success")">
                                    @(user.LockoutEnabled ? "Deactivate" : "Active")
                                </span>
                            </td>

                            <td class="p-3 d-flex justify-content-center gap-2">
                                <a href="@Url.Action("AccountDetail", "AdminAccount", new { id = user.Id })" class="btn btn-icon btn-pills btn-soft-primary">
                                    <i class="bi bi-eye-fill"></i>
                                </a>
                                <form method="post" asp-controller="AdminAccount" asp-action="DeleteUser" id="deleteUserForm-@user.Id">
                                    <input type="hidden" name="id" value="@user.Id" />
                                </form>
                                <a href="javascript:void(0)"
                                   class="btn btn-icon btn-pills btn-soft-danger"
                                   onclick="if (confirm('Are you sure you want to delete this user?'))
                document.getElementById('deleteUserForm-@user.Id').submit();">
                                    <i class="bi bi-trash-fill"></i>
                                </a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div class="row text-center">
            <div class="col-12 mt-4">
                <ul class="pagination justify-content-center mb-0">
                    @if (ViewBag.CurrentPage > 1)
                    {
                        <li class="page-item">
                            <a class="page-link" href="@Url.Action("AccountList", "AdminAccount", new { searchQuery = ViewBag.SearchQuery, page = ViewBag.CurrentPage - 1 })">Prev</a>
                        </li>
                    }

                    @for (int i = 1; i <= ViewBag.TotalPages; i++)
                    {
                        <li class="page-item @(i == ViewBag.CurrentPage ? "active" : "")">
                            <a class="page-link" href="@Url.Action("AccountList", "AdminAccount", new { searchQuery = ViewBag.SearchQuery, page = i })">@i</a>
                        </li>
                    }

                    @if (ViewBag.CurrentPage < ViewBag.TotalPages)
                    {
                        <li class="page-item">
                            <a class="page-link" href="@Url.Action("AccountList", "AdminAccount", new { searchQuery = ViewBag.SearchQuery, page = ViewBag.CurrentPage + 1 })">Next</a>
                        </li>
                    }
                </ul>
            </div>
        </div>
    </div>
</main>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addUserModalLabel">Add new user</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" asp-controller="AdminAccount" asp-action="AddUser" id="addUserForm">
                <div class="modal-body fw-bold">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label" for="username">Username</label>
                            <input type="text" id="username" name="Username" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" for="phone">Phone number</label>
                            <input type="text" id="phone" name="PhoneNumber" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" for="email">Email</label>
                            <input type="email" id="email" name="Email" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" for="dob">Date of birth</label>
                            <input type="date" id="dob" name="DateOfBirth" class="form-control">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Role</label>
                            <select name="Role" class="form-select">
                                <option value="" selected disabled>--Select role--</option>
                                <option value="Customer">Customer</option>
                                <option value="Admin">Admin</option>
                                <option value="Sales">Sales</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer mt-3">
                    <button type="submit" class="btn btn-dark w-100">+ Add new user</button>
                </div>
            </form>
        </div>
    </div>
</div>
